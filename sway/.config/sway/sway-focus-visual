#!/usr/bin/env python3
"""
Highlight focused window without resizing geometry:
- Keeps a consistent border width (default 1px).
- Uses opacity to dim unfocused windows (default 0.65) and full opacity for focused.
Configurable via env: BASE_BORDER, FOCUSED_OPACITY, UNFOCUSED_OPACITY.
Depends on python3-i3ipc (same as autotiling).
"""
import os
import sys
from i3ipc import Connection, Event

BASE_BORDER = int(os.getenv("BASE_BORDER", "1"))
FOCUSED_OPACITY = float(os.getenv("FOCUSED_OPACITY", "1"))
UNFOCUSED_OPACITY = float(os.getenv("UNFOCUSED_OPACITY", "0.75"))


def is_window(con) -> bool:
    return con.type in ("con", "floating_con")


def set_all_windows(i3, opacity: float) -> None:
    tree = i3.get_tree()
    for con in tree.descendents():
        if is_window(con):
            set_border_and_opacity(con, BASE_BORDER, opacity)


def set_border_and_opacity(con, border: int, opacity: float) -> None:
    try:
        con.command(f"border pixel {border}")
        con.command(f"opacity {opacity}")
    except Exception as e:
        # Sway might occasionally reject commands on transient containers; swallow quietly.
        _ = e


def main() -> None:
    try:
        i3 = Connection()
    except Exception as e:
        sys.exit(0)

    prev_id = None

    def apply_focus_state(_i3, focused_con) -> None:
        nonlocal prev_id
        if not focused_con or not is_window(focused_con):
            # If focus is lost (e.g. during slurp/grim), keep existing opacity state
            return

        if prev_id is None:
            set_all_windows(_i3, UNFOCUSED_OPACITY)

        if prev_id and prev_id != focused_con.id:
            prev = _i3.get_tree().find_by_id(prev_id)
            if prev and is_window(prev):
                set_border_and_opacity(prev, BASE_BORDER, UNFOCUSED_OPACITY)

        set_border_and_opacity(focused_con, BASE_BORDER, FOCUSED_OPACITY)
        prev_id = focused_con.id

    def on_focus(_i3, event) -> None:
        apply_focus_state(_i3, event.container)

    def on_new(_i3, event) -> None:
        con = event.container
        if con and is_window(con):
            set_border_and_opacity(con, BASE_BORDER, UNFOCUSED_OPACITY)

    def on_workspace_focus(_i3, _event) -> None:
        if _event.current and not _event.current.leaves():
            apply_focus_state(_i3, None)
            return
        focused_con = _i3.get_tree().find_focused()
        apply_focus_state(_i3, focused_con)

    set_all_windows(i3, UNFOCUSED_OPACITY)
    apply_focus_state(i3, i3.get_tree().find_focused())

    i3.on(Event.WINDOW_FOCUS, on_focus)
    i3.on(Event.WINDOW_NEW, on_new)
    i3.on(Event.WORKSPACE_FOCUS, on_workspace_focus)

    try:
        i3.main()
    except Exception:
        pass


if __name__ == "__main__":
    main()
